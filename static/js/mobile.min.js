!function(e){var t=function(e,n){function o(e){if(e.isEle)return e;e.isEle=!0;var n={prototype:Element,val:function(e){return"string"==typeof e?this.value=e:this.value},html:function(e){return"string"==typeof e?this.innerHTML=e:this.innerHTML},next:function(){for(var e=this.nextSibling;e instanceof Text;)e=e.nextSibling;return t(e)},addClass:function(e){return-1==this.className.split(" ").indexOf(e)&&(this.className+=" "+e),this},removeClass:function(e){var t=this.className.split(" ");if(-1!=t.indexOf(e))return t.splice(t.indexOf(e),1),this.className=t.join(" "),this},hasClass:function(e){return this.className.split(" ").indexOf(e)>-1},ele:function(e){return t(e,this)},getInput:function(e){return this.ele("input[name="+e+"]")[0]},addEvent:function(e,t){return this.addEventListener?this.addEventListener(e,t):this.attachEvent&&this.attachEvent("on"+e,function(e){(e=e||window.event).target=e.target||e.srcElement,t(e)}),this},target:function(e){if("string"==typeof e)if(document.dispatchEvent){var t=document.createEvent("HTMLEvents");t.initEvent(e,!0,!0),this.dispatchEvent(t)}else document.attachEvent&&this.fireEvent("on"+e);return this}};if(e.__proto__)n.__proto__=e.__proto__,e.__proto__=n;else for(var o in n)e[o]=n[o];return e}if(!e)return e;if("string"!=typeof e&&e instanceof Element)return o(e);var a;if(n=n||document,(a=2==e.split("#").length?document.getElementById(e.split("#")[1]):n.querySelectorAll(e))instanceof Element)a=o(a);else if(a){for(var r=0;r<a.length;r++)o(a[r]);a.call=function(e,t,n){for(var o=0;o<a.length;o++)a[o][e](t,n)}}else console.error("unknow ele type ",e);return a},n=function(e,t){this.routes=e,this.views=t};n.prototype={constructor:n,run:function(){var e=this;return this._action(),this._bindEvent(),window.addEventListener("hashchange",function(){e._action()}),this},_action:function(){var e=location.hash.split("#")[1],t=this.routes;t._init&&t._init(),t.hasOwnProperty(e)?(this.views[e].removeClass("none"),t[e](this)):t.other&&t.other(this)},_bindEvent:function(){var e=this;for(var t in e.views){var n=e.views[t];n.ele(".redirect-back").call("addEvent","click",function(){e.back()});for(var o in e.views)!function(t){n.ele(".redirect-"+t).call("addEvent","click",function(){e.redirect(t)})}(o)}return this},back:function(){return history.back(),this},redirect:function(e){location.hash="#"+e}};var o=function(o){var a=this;this.options=o||{},this.views={login:t(".m-dz-login")[0],smslogin:t(".m-dz-sms-login")[0],register:t(".m-dz-register")[0],forgetword:t(".m-dz-forgetword")[0],resetpwd:t(".m-dz-resetpwd")[0],bindphone:t(".m-dz-bind-phone")[0]};var r={_init:function(){e.innerHTML=""},login:function(t){e.appendChild(a.views.login),a.run_login()},smslogin:function(t){e.appendChild(a.views.smslogin),a.run_sms_login()},register:function(t){e.appendChild(a.views.register),a.run_register()},forgetword:function(t){e.appendChild(a.views.forgetword),a.run_forgetpwd()},resetpwd:function(t){e.appendChild(a.views.resetpwd),a.run_resetpwd()},bindphone:function(t){e.appendChild(a.views.bindphone),a.run_bindphone()},other:function(e){e.redirect("login")}};this.router=new n(r,a.views).run()};o.prototype={constructor:o,ajax:function(e){var t,n=this.options.site_url+e.url,o=e.success,a=e.error,r=e.type||"GET",s=e.data||null;window.ActiveXObject?t=new ActiveXObject("Microsoft.XMLHTTP"):window.XMLHttpRequest&&(t=new XMLHttpRequest),t.open(r,n),"undefined"==typeof FormData&&t.setRequestHeader("Content-Type","application/json; charset=utf-8"),t.send(function(e){if("object"!=typeof e)return e;if("function"==typeof FormData){var t=new FormData;for(var n in e)t.append(n,e[n]);return t}var o=new Array,a=0;for(var n in e)o[a]=encodeURIComponent(n)+"="+encodeURIComponent(e[n]),a++;return o.join("&")}(s)),t.onreadystatechange=function(e){if(4===t.readyState){var n=JSON.parse(t.responseText);200===t.status&&200===n.status?o&&o(n):a&&a(n)}}},isPhone:function(e){return e.trim().length>5},initVaptcha:function(e){var t=this,n=e.form,o=e.success;e.scene=e.scene||"";var a=new function(){this.isPass=!1,this.vaptcha=null,this.refresh=function(){this.isPass&&(this.vaptcha.destroy(),t.initVaptcha(e))}},r=function(){t.ajax({url:"/plugin.php?id=phone_auth&action=getChallenge&scene="+e.scene+"&t="+(new Date).getTime(),success:function(r){var s={vid:(r=r.data).vid,challenge:r.challenge,container:e.element,type:e.type||"popup",style:t.options.vaptcha_style||"dark",https:e.https||!1,color:t.options.vaptcha_color||"#3c8aff",lang:"zh-CN",outage:"/plugin.php?id=phone_auth&action=downtime",success:function(e,t){if(n){var r=n.getElementsByTagName("input");r.vaptcha_challenge.value=t,r.vaptcha_token.value=e}a.isPass=!0,o&&o(e,t)}};window.vaptcha(s,function(e){if(n){var t=n.getElementsByTagName("input");t.vaptcha_challenge.value="",t.vaptcha_token.value=""}a.vaptcha=e,a.vaptcha.init()})}})},s=document.getElementById("vaptcha_v_js");return s?r():(s=document.createElement("script"),protocol="https",s.src=protocol+"://cdn.vaptcha.com/v.js",s.id="vaptcha_v_js",s.onload=s.onreadystatechange=function(){this.readyState&&"loaded"!=this.readyState&&"complete"!=this.readyState||(r(),s.onload=s.onreadystatechange=null)},document.getElementsByTagName("head")[0].appendChild(s)),a},formValidate:function(e,t){e.forEach(function(e){var n=t.getElementsByTagName("input")[e.name];n.addEventListener("input",function(){e.validator(n.value,n)}),n.addEventListener("focus",function(){n.removeClass("error")}),n.addEventListener("blur",function(){e.validator(n.value,n)})})},buttonCountDown:function(e,t){var n=this;t=t||120,e.setAttribute("disabled","disabled"),function o(){if(0==t)return e.removeAttribute("disabled"),void(e.innerText=n.options.lang.send_code);e.innerText=t+"s",t--,setTimeout(o,1e3)}()},getFormData:function(e){for(var t=e.ele("input"),n={},o=0;o<t.length;o++)t[o].name&&(n[t[o].name]=t[o].value);return n},passwordLevel:function(e,t){e.addEvent("keyup",function(n){n=n||window.event;var o=new RegExp("^(?=.{8,})(?=.*[A-Z])(?=.*[a-z])(?=.*[0-9])(?=.*\\W).*$","g"),a=new RegExp("^(?=.{7,})(((?=.*[A-Z])(?=.*[a-z]))|((?=.*[A-Z])(?=.*[0-9]))|((?=.*[a-z])(?=.*[0-9]))).*$","g"),r=(new RegExp("(?=.{6,}).*","g"),new RegExp("[a-zA-Z]"));e.value.length>=6?o.test(e.value)?(t.removeClass("pw-medium"),t.removeClass("pw-weak"),t.addClass("pw-strong"),canBeSubmit=!0):a.test(e.value)||r.test(e.value)?(t.removeClass("pw-strong"),t.removeClass("pw-weak"),t.addClass("pw-medium"),canBeSubmit=!0):(t.removeClass("pw-strong"),t.removeClass("pw-medium"),t.addClass("pw-weak"),canBeSubmit=!1):e.value.length>0&&e.value.length<6?(t.removeClass("pw-strong"),t.removeClass("pw-medium"),t.addClass("pw-weak"),canBeSubmit=!1):(t.removeClass("pw-strong"),t.removeClass("pw-medium"),t.removeClass("pw-weak"),canBeSubmit=!1),13==n.keyCode&&signUp()})},showMsg:function(e,t){var n=document.createElement("div");n.className="dz-m-tip "+(t?"dz-m-tip-success":""),n.innerHTML='<div class="dz-m-cont"><span class="dz-tip-icon"></span><span class="dz-tip-text">'+e+"</span></div>",document.body.appendChild(n),this.modalTimer=setTimeout(function(){n&&n.parentNode.removeChild(n)},1500)},initCountryCode:function(e){var n=e.ele(".dropdown-menu")[0],o=(e=e.ele("#phonePrefix")).ele(".btn-down")[0],a=function(){n.style.display="block",o.addClass("open")},r=function(){n.style.display="none",o.removeClass("open")};e.getInput("country_code").addEvent("focus",a),e.ele(".btn-down")[0].addEvent("click",function(){n.style.display="block"==n.style.display?r():a()}),t("body")[0].addEvent("click",function(t){var n=t.target;!e.contains(n)&&r()}),n.ele(".dropdown-item").call("addEvent","click",function(t){r(),e.getInput("country_code").value=t.target.innerHTML.split("+")[1].trim()})},loging_loaded:!1,run_login:function(){if(!this.loging_loaded){this.loging_loaded=!0;var e,n=this,o=t(".m-dz-login")[0],a=o.ele(".vaptcha_container")[0],r=o.ele(".login-btn")[0],s=(o.ele("input"),function(){var e=o.getInput("user"),t=o.getInput("password");e.val()&&t.val().length>5?r.removeAttribute("disabled"):r.setAttribute("disabled","disabled")});this.options.login_captcha&&(e=n.initVaptcha({scene:"01",form:o,element:a,success:s})),n.formValidate([{name:"user",validator:function(e,t){s(),e?t.removeClass("error"):t.addClass("error")}},{name:"password",validator:function(e,t){s(),6>e.length?t.addClass("error"):t.removeClass("error")}}],o),r.addEvent("click",function(){n.ajax({url:"/plugin.php?id=phone_auth&mod=logging&action=login&loginsubmit=yes",type:"POST",data:n.getFormData(o),success:function(e){window.location.href=n.options.site_url+"/forum.php?mobile=yes"},error:function(t){["user","password","vaptcha"].indexOf(t.error_pos)>=0&&(o.getInput(t.error_pos)&&o.getInput(t.error_pos).addClass("error"),n.showMsg(t.msg)),"bind_phone"===t.error_pos&&n.router.redirect("bindphone"),n.options.login_captcha&&e.refresh(),r.setAttribute("disabled","disabled")}})})}},smslogin_loaded:!1,run_sms_login:function(){if(!this.smslogin_loaded){this.smslogin_loaded=!0;var e=this,n=t(".m-dz-sms-login")[0],o=n.ele(".vaptcha_container")[0],a=n.ele(".dz-btn-code")[0],r=n.ele(".login-btn")[0],s=n.ele("input"),i=function(){var t=e.getFormData(n);e.isPhone(t.phone)&&/^\d{6}$/.test(t.code)?r.removeAttribute("disabled"):r.setAttribute("disabled","disabled")},u=e.initVaptcha({scene:"01",form:n,element:o,success:function(){i(),a.click(),n.ele(".send-code-group")[0].removeClass("none")}});n.getInput("phone").addEvent("keyup",function(e){var t=e.target;!Number(t.value)&&(t.value=parseInt(t.value)?parseInt(t.value):"")});var l=!1;a.addEvent("click",function(){l||(i(),l=!0,e.ajax({url:"/plugin.php?id=phone_auth&action=sendlogincode",type:"POST",data:{phone:n.getInput("phone").value,vaptcha_token:n.getInput("vaptcha_token").value,vaptcha_challenge:n.getInput("vaptcha_challenge").value},success:function(t){l=!1,e.showMsg(t.msg,!0),e.buttonCountDown(a)},error:function(t){l=!1,"vaptcha"===t.error_pos&&u.refresh(),"phone"===t.error_pos&&n.getInput("phone").addClass("error"),301===t.status?e.buttonCountDown(a,t.msg):e.showMsg(t.msg)}}))}),s.call("addEvent","keyup",i),s.call("addEvent","blur",i),s.call("addEvent","focus",function(e){e.target.removeClass("error")}),r.addEvent("click",function(){e.ajax({url:"/plugin.php?id=phone_auth&mod=logging&action=smslogin&loginsubmit=yes",type:"POST",data:e.getFormData(n),success:function(t){window.location.href=e.options.site_url+"/forum.php?mobile=yes"},error:function(t){["phone","code"].indexOf(t.error_pos)>=0&&(n.getInput(t.error_pos)&&n.getInput(t.error_pos).addClass("error"),e.showMsg(t.msg)),"vaptcha"==t.error_pos&&u.refresh(),r.setAttribute("disabled","disabled")}})})}},forgetpwd_loaded:!1,run_forgetpwd:function(){var e=this,n=t(".m-dz-forgetword")[0],o=n.ele("input"),a=n.ele(".dz-btn-code")[0];if(this.forgetpwd_loaded)o.call("val","");else{this.forgetpwd_loaded=!0;var r=function(){e.isPhone(n.getInput("phone").value)&&n.getInput("phone").removeClass("error"),/^\d{6}$/.test(n.getInput("code").value)&&n.getInput("code").removeClass("error"),e.isPhone(n.getInput("phone").value)&&/^\d{6}$/.test(n.getInput("code").value)?n.ele(".next-step")[0].removeAttribute("disabled"):n.ele(".next-step")[0].setAttribute("disabled","disabled")},s=e.initVaptcha({element:n.ele(".vaptcha_container")[0],form:n,success:function(){r(),a.click(),n.ele(".send-code-group")[0].removeClass("none")}}),i=!1;a.addEvent("click",function(){i||(r(),i=!0,e.ajax({url:"/plugin.php?id=phone_auth&action=sendcode",type:"POST",data:{phone:n.getInput("phone").value,vaptcha_token:n.getInput("vaptcha_token").value,vaptcha_challenge:n.getInput("vaptcha_challenge").value},success:function(t){i=!1,e.showMsg(t.msg,!0),e.buttonCountDown(a)},error:function(t){i=!1,"vaptcha"===t.error_pos&&s.refresh(),"phone"===t.error_pos&&n.getInput("phone").addClass("error"),301===t.status?e.buttonCountDown(a,t.msg):e.showMsg(t.msg)}}))}),o.call("addEvent","keyup",r),o.call("addEvent","blur",r),o.call("addEvent","focus",function(e){e.target.removeClass("error")}),n.ele(".next-step")[0].addEvent("click",function(){e.ajax({url:"/plugin.php?id=phone_auth&action=verifyCode",type:"POST",data:{phone:n.getInput("phone").value,code:n.getInput("code").value},success:function(t){n.addClass("none"),e.router.redirect("resetpwd")},error:function(t){n.ele(".next-step")[0].setAttribute("disabled","disabled"),["phone","code"].indexOf(t.error_pos)>=0&&n.getInput(t.error_pos).addClass("error"),e.showMsg(t.msg)}})})}},resetpwd_loaded:!1,run_resetpwd:function(){var e=this;form=t(".m-dz-resetpwd")[0],inputs=form.ele("input"),oPass=form.getInput("new_password"),e.passwordLevel(form.getInput("new_password"),form.ele(".pw-strength")[0]),this.resetpwd_loaded?inputs.call("val",""):(this.resetpwd_loaded=!0,inputs.call("addEvent","keyup",function(){form.getInput("new_password").value==form.getInput("verify_password").value&&form.getInput("new_password").value.length>5&&form.getInput("new_password").value.length<21?form.ele(".submit-btn")[0].removeAttribute("disabled"):form.ele(".submit-btn")[0].setAttribute("disabled","disabled")}),form.getInput("verify_password").addEvent("blur",function(){form.getInput("new_password").value!=form.getInput("verify_password").value&&e.showMsg(e.options.lang.password_not_match)}),form.ele(".submit-btn")[0].addEvent("click",function(){e.ajax({url:"/plugin.php?id=phone_auth&action=resetPassword",type:"POST",data:{new_password:form.getInput("new_password").value},success:function(t){e.showMsg(t.msg,!0),setTimeout(function(){e.router.redirect("login")},1e3)},error:function(t){e.showMsg(t.msg)}})}))},register_loaded:!1,run_register:function(){function e(){var e=a.username&&a.email&&a.password&&a.phone;return e&&a.code?t("#register_btn").removeAttribute("disabled"):t("#register_btn").setAttribute("disabled","disabled"),e}if(!this.register_loaded){this.register_loaded=!0;var n=this,o=n.options.register,a={username:!1,email:0==o.has_email,password:!1,phone:!1,vaptcha:!1,code:!1},r=t(".m-dz-register")[0],s=r.ele(".dz-btn-code")[0];this.options.enable_inter&&(this.initCountryCode(r),r.getInput("country_code").addEvent("keyup",function(e){var t=e.target;!Number(t.value)&&(t.value=parseInt(t.value)?parseInt(t.value):""),a.phone=n.isPhone(t.value)}));var i=n.initVaptcha({element:r.ele(".vaptcha_container")[0],form:r,success:function(){a.vaptcha=!0,r.ele(".dz-code-group")[0].removeClass("none"),s.target("click"),e()}});n.passwordLevel(r.getInput(o.password),r.ele(".pw-strength")[0]),r.getInput(o.password).addEvent("keyup",function(e){var t=e.target;a.password=t.value.length>=6&&t.value.length<=20}),r.getInput(o.password).addEvent("focus",function(e){r.ele(".pw-strength")[0].removeClass("error")}),r.getInput(o.password).addEvent("blur",function(e){var t=e.target;t.value.length<6||t.value.length>20?(a.password=!1,r.ele(".pw-strength")[0].addClass("error")):a.password=!0}),r.getInput(o.username).addEvent("keyup",function(e){var t=e.target;t.value=t.value.trim(),a.username=!(t.value.length<3||t.value.length>15)}),r.getInput(o.username).addEvent("blur",function(e){var t=e.target;a.username||(a.username=!1,t.addClass("error"))}),o.has_email&&(r.getInput(o.email).addEvent("keyup",function(e){var t=e.target;t.value=t.value.trim(),a.email=/^(\w)+(\.\w+)*@(\w)+((\.\w{2,3}){1,3})$/.test(t.value)}),r.getInput(o.email).addEvent("blur",function(e){var t=e.target;a.email||t.addClass("error")})),r.getInput("phone").addEvent("keyup",function(e){var t=e.target;!Number(t.value)&&(t.value=parseInt(t.value)?parseInt(t.value):""),a.phone=n.isPhone(t.value)}),r.getInput("phone").addEvent("blur",function(e){var t=e.target;t.target("keyup"),a.phone||(t.addClass("error"),n.showMsg("&#35831;&#36755;&#20837;&#27491;&#30830;&#30340;&#25163;&#26426;&#21495;"))}),r.getInput("code").addEvent("keyup",function(e){var t=e.target;t.value=t.value.trim(),a.code=/^\d{6}$/.test(t.value)}),r.getInput("code").addEvent("blur",function(e){var t=e.target;t.target("keyup"),!a.code&&t.addClass("error")});var u=!1;s.addEvent("click",function(){if(r.getInput("phone").target("blur"),!a.phone||u)return!1;u=!0,n.ajax({url:"/plugin.php?id=phone_auth&action=sendRegisterCode",type:"POST",data:{phone:r.getInput("phone").value,country_code:r.getInput("country_code").value.trim(),vaptcha_token:r.getInput("vaptcha_token").value,vaptcha_challenge:r.getInput("vaptcha_challenge").value},success:function(e){u=!1,n.buttonCountDown(s)},error:function(e){u=!1,"vaptcha"===e.error_pos&&i.refresh(),["phone","code"].indexOf(e.error_pos)>=0&&r.getInput(e.error_pos).addClass("error"),301===e.status?n.buttonCountDown(s,e.msg):n.showMsg(e.msg)}})}),t("#register_btn").addEvent("click",function(){var e=n.getFormData(r);e.agreebbrule=o.agreebbrule,n.ajax({url:"/plugin.php?id=phone_auth&action=register",data:e,type:"POST",success:function(e){200===e.status&&(location.href=n.options.site_url+"/forum.php?mobile=yes")},error:function(e){r.getInput(o.username),r.getInput(o.email);n.showMsg(e.msg),["username","email"].indexOf(e.error_pos)>=0&&r.getInput(o[e.error_pos]).addClass("error")}})}),r.ele("input").call("addEvent","keyup",e),r.ele("input").call("addEvent","focus",function(e){e.target.removeClass("error")})}},bindphone_loaded:!1,run_bindphone:function(){var e=this,n=t(".m-dz-bind-phone")[0],o=n.ele("input"),a=n.ele(".dz-btn-code")[0];if(this.bindphone_loaded)o.call("val","");else{this.bindphone_loaded=!0;var r=function(){e.isPhone(n.getInput("phone").value)&&n.getInput("phone").removeClass("error"),/^\d{6}$/.test(n.getInput("code").value)&&n.getInput("code").removeClass("error"),e.isPhone(n.getInput("phone").value)&&/^\d{6}$/.test(n.getInput("code").value)?n.ele(".next-step")[0].removeAttribute("disabled"):n.ele(".next-step")[0].setAttribute("disabled","disabled")};this.options.enable_inter&&(this.initCountryCode(n),n.getInput("country_code").addEvent("keyup",function(t){var n=t.target;!Number(n.value)&&(n.value=parseInt(n.value)?parseInt(n.value):""),inputsValidate.phone=e.isPhone(n.value)}));var s=e.initVaptcha({element:n.ele(".vaptcha_container")[0],form:n,success:function(){r(),a.click(),n.ele(".send-code-group")[0].removeClass("none")}}),i=!1;a.addEvent("click",function(){i||(r(),i=!0,e.ajax({url:"/plugin.php?id=phone_auth&action=bindphonecode",type:"POST",data:{phone:n.getInput("phone").value,country_code:n.getInput("country_code").value.trim(),vaptcha_token:n.getInput("vaptcha_token").value,vaptcha_challenge:n.getInput("vaptcha_challenge").value},success:function(t){i=!1,e.showMsg(t.msg,!0),e.buttonCountDown(a)},error:function(t){i=!1,"vaptcha"===t.error_pos&&s.refresh(),"phone"===t.error_pos&&n.getInput("phone").addClass("error"),301===t.status?e.buttonCountDown(a,t.msg):e.showMsg(t.msg)}}))}),o.call("addEvent","keyup",r),o.call("addEvent","focus",function(e){e.target.removeClass("error")}),n.ele(".next-step")[0].addEvent("click",function(){e.ajax({url:"/plugin.php?id=phone_auth&action=bindphone",type:"POST",data:{phone:n.getInput("phone").value,code:n.getInput("code").value},success:function(t){n.addClass("none"),window.location.href=e.options.site_url+"/forum.php?mobile=yes"},error:function(t){n.ele(".next-step")[0].setAttribute("disabled","disabled"),["phone","code"].indexOf(t.error_pos)>=0&&n.getInput(t.error_pos).addClass("error"),e.showMsg(t.msg)}})})}}},window.helper=o}(document.getElementById("app"));