var Pagination=function(e){var e=e||{};this.page=document.querySelector(e.selector||".pagination"),this.nextElement=this.page.querySelector(e.next||".next"),this.prevElement=this.page.querySelector(e.prev||".prev"),this.goButton=this.page.querySelector(e.to||".to"),this.inputPage=this.page.querySelector(e.pageInput||'input[name="page"]'),this.currentPage=e.currentPage||1,this.pageTotal=e.pageTotal||1,this.length=e.length||10,this.changeHandle=e.changeHandle||function(){},this._bindEventlistener()};Pagination.prototype={constructor:Pagination,_createPage:function(e){var t=document.createElement("li"),i=document.createElement("a");i.innerText=e,t.classList.add("page-"+e),t.appendChild(i),this.page.insertBefore(t,this.nextElement),this.items.push(t),"number"==typeof e&&t.addEventListener("click",function(){this.to(Number(t.innerText))}.bind(this))},_createPages:function(){if(this.items=[],this.pageTotal>this.length){this.currentPage>5&&(this._createPage(1),this.currentPage>6&&this._createPage("..."));for(e=this.currentPage-4;e<=this.currentPage+5;e++)e>0&&e<this.pageTotal&&this._createPage(e);this.currentPage<this.pageTotal-5&&this._createPage("..."),this._createPage(this.pageTotal)}else for(var e=1;e<=this.pageTotal;e++)this._createPage(e)},_bindEventlistener:function(){this._createPages(),this.nextElement.addEventListener("click",this.next.bind(this)),this.prevElement.addEventListener("click",this.prev.bind(this)),this.goButton&&this.goButton.addEventListener("click",function(){this.to(Number(this.inputPage.value))}.bind(this)),this.inputPage&&this.inputPage.addEventListener("keyup",function(e){13===(e=e||window.event).keyCode&&this.to(Number(this.inputPage.value))}.bind(this)),this._updateView(!0)},next:function(){return this.currentPage<this.pageTotal&&this.currentPage++,this._updateView(),this},prev:function(){return this.currentPage>1&&this.currentPage--,this._updateView(),this},to:function(e){return e!=this.currentPage&&e<=this.pageTotal&&e>0&&(this.currentPage=e,this._updateView()),this},reset:function(e){e&&(this.pageTotal=e),this.currentPage=1,this._updateView(!0)},_removeDoms:function(){this.items.forEach(function(e){e.remove()})},_updateView:function(e){!e&&this.changeHandle(this.currentPage),this._removeDoms(),this._createPages(),this.items.forEach(function(e){e.classList.remove("active")}),this.page.style.display=this.pageTotal<=1?"none":"inline-block",1===this.currentPage?this.prevElement.classList.add("disabled"):this.prevElement.classList.remove("disabled"),this.currentPage===this.pageTotal?this.nextElement.classList.add("disabled"):this.nextElement.classList.remove("disabled"),this.page.getElementsByClassName("page-"+this.currentPage)[0].classList.add("active")}};var helper=function(e){this.config=e,this.selectedAmount=5e3,this.alipayToken="",this.wechatToken="",this.checkPayTimer,this.page};helper.prototype={constructor:helper,init:function(){this.initTabs(),this.initSelectAmount(),this.setAliayUrl(),this.getOrdersData(),this.initPayEvents()},initSetting:function(){$("#picker").colpick({layout:"hex",submit:0,colorScheme:"dark",onChange:function(e,t,i,a,n){$(a).css("border-color","#"+t),n||$(a).val(t)}}).keyup(function(){$(this).colpickSetColor(this.value)});var e;$(".v-settings").submit(function(){if($(".v-settings input[name=site_name]").val().replace(/[\\u0391-\\uFFE5]/g,"aa").length>20)return $(".message").show(),e=setTimeout(function(){$(".message").hide()},1e3),!1})},initTabs:function(){var e=this,t=$(".tab .v-btn"),i=$(".tab-panel");t.click(function(){t.removeClass("active"),i.removeClass("active"),$(this).addClass("active");var a=t.index(this);$(i[a]).addClass("active"),0==a&&e.getOrdersData(),1==a&&e.getSendRecord()})},initSelectAmount:function(){var e=[{price:3.5,num:5e3,market:4.5},{price:3.2,num:2e4,market:4.3},{price:2.8,num:5e4,market:"4.0"},{price:2.5,num:2e5,market:3.9},{price:2.2,num:5e5,market:3.8}],t=$(".recharge .prices span"),i=this;t.click(function(a){var n=t.index(this);t.removeClass("active"),$(this).addClass("active"),i.selectedAmount=e[n].num,$("input[name=pay]:checked").val()&&i.setAliayUrl(),$(".recharge .v-money .price-total").text("\uffe5"+(e[n].price*e[n].num/100).toFixed(2)),$(".recharge .v-money .price").text(e[n].price),$(".recharge .market").text(e[n].market)})},setAliayUrl:function(){var e=this,t=this.config.site_url+"/plugin.php?id=phone_auth&action=smspay&type=alipay&amount="+e.selectedAmount;$.get(t,function(t){e.alipayToken=t.token,$(".online-pay-btn").attr("href",t.url)},"json")},showMsg:function(e){$(".vaptcha-dz-tip.message .dz-tip-text .text").text(e),$(".vaptcha-dz-tip.message").show(),setTimeout(function(){$(".vaptcha-dz-tip.message").hide()},1500)},initPayEvents:function(){var e=null,t=this;$(".online-pay-btn").click(function(){if(1==t.config.active){if($(".online-pay-btn").hasClass("disabled"))return!1;if(24!=t.config.params.vid.length||32!=t.config.params.key.length)return $(".please-finish-config").show(),e&&clearTimeout(e),e=setTimeout(function(){$(".vaptcha-dz-tip").hide()},1e3),!1;if("wechat"===$("input[name=pay]:checked").val()){if($(".vaptcha-dz-qrcode").hasClass("active"))return!1;var i=t.config.site_url+"/plugin.php?id=phone_auth&action=smspay&type=wechat&amount="+t.selectedAmount;return $.get(i,function(e){t.wechatToken=e.token,$(".vaptcha-dz-qrcode img").attr("src","data:image/png;base64, "+e.data),$(".vaptcha-dz-qrcode").addClass("active"),t.checkPayState(t.wechatToken)},"json"),!1}$(".alipay-pop").show(),t.checkPayTimer=setTimeout(function(){t.checkPayState(t.alipayToken)},5e3)}else t.showMsg("\u8bf7\u5148\u5f00\u542f\u63d2\u4ef6")}),$(".alipay-pop .finish-pay").click(function(){t.checkPayState(t.alipayToken,!0)}),$(".alipay-pop .close").click(function(){t.checkPayTimer&&clearTimeout(t.checkPayTimer),$(".alipay-pop").hide("active")}),$(".vaptcha-dz-qrcode .close").click(function(){t.checkPayTimer&&clearTimeout(t.checkPayTimer),$(".vaptcha-dz-qrcode").removeClass("active")}),$(".agreement-link").click(function(){$(".dz-sms-pop").show()}),$(".dz-sms-pop .close").click(function(){return $(".dz-sms-pop").hide(),!1}),$("#agreement").change(function(){this.checked?$(".online-pay-btn").removeClass("disabled"):$(".online-pay-btn").addClass("disabled")})},getOrdersData:function(){var e=this;$.get(this.config.site_url+"/plugin.php?id=phone_auth&action=smsdata&type=order&page=0",function(t){if(200===t.code){t=t.data,$(".surplus-count .count").html(t.amount),$(".surplus-day .day").html(t.expecttime);var i="";for(var a in t.orders){var n=t.orders[a];i+="<tr><td>"+n.amount+"</td><td>"+n.payment+"</td><td>"+e.config.lang[n.paytype]+"</td><td>"+n.orderid+"</td><td>"+new Date(n.createtime).toLocaleString()+"</td></tr>"}i&&$(".recharge .record tbody").html(i)}else console.error("get data error")},"json")},getSendRecord:function(e){var t=this;e=e||1,$.get(this.config.site_url+"/plugin.php?id=phone_auth&action=smsdata&type=send&page="+(e-1),function(i){if(200===i.code){i=i.data,e&&t.initStatistics(i.statistics);var a="";for(var n in i.records){var s=i.records[n];a+="<tr><td>"+s.countrycode+"</td><td>"+s.phone+"</td><td>"+s.content+"</td><td>"+s.consume+"</td><td>"+s.type+"</td><td>"+("100"==s.statucode?'<i class="iconfont success">&#xe652;</i>':'<i class="iconfont error">&#xe70d;<span>'+t.config.lang.error_code+s.statucode+"</span></i>")+"</td><td>"+new Date(s.createtime).toLocaleString()+"</td></tr>"}a&&$(".log tbody").html(a),t.page=t.page||new Pagination({pageTotal:Math.ceil(i.total/20),changeHandle:function(){t.getSendRecord(this.currentPage)}})}else console.error("get data error")},"json")},showState:function(e){$(".vaptcha-dz-pop").hide(),$(".vaptcha-dz-tip").hide(),$(".vaptcha-dz-qrcode").removeClass("active"),$(".pay-"+e).show(),setTimeout(function(){$(".pay-"+e).hide()},3e3)},checkPayState:function(e,t){var i=this;$.get(this.config.site_url+"/plugin.php?id=phone_auth&action=paycheck&token="+e,function(a){var n=a.data;if(i.checkPayTimer&&clearTimeout(i.checkPayTimer),"0"==n){if(t)return void i.showState("error");i.checkPayTimer=setTimeout(function(){i.checkPayState(e)},1e3)}else"2"==n?(i.getOrdersData(),i.showState("success")):i.showState("error")},"json")},initStatistics:function(e){for(var t=echarts.init(document.getElementById("echart")),i=[],a=[],n=0;n<e.length;n++)i.push(e[n].date),a.push(e[n].count);var s={color:["#0088ff"],grid:{left:50,top:20,right:50},tooltip:{trigger:"axis"},legend:{width:$(".curve").width()+"px"},xAxis:{type:"category",boundaryGap:!1,data:i},yAxis:{type:"value"},series:[{name:this.config.lang.send_count,type:"line",smooth:!0,data:a}]};t.setOption(s),t.resize({width:$(".curve").width()}),window.onresize=function(){t.resize({width:$(".curve").width()})}}};