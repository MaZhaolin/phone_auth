!function(){Array.prototype.indexOf||(Array.prototype.indexOf=function(e,t){if(null==this)throw new TypeError("Array.prototype.indexOf() - can't convert `"+this+"` to object");var n=isFinite(t)?Math.floor(t):0,a=this instanceof Object?this:new Object(this),o=isFinite(a.length)?Math.floor(a.length):0;if(n>=o)return-1;if(n<0&&(n=Math.max(o+n,0)),void 0===e){do{if(n in a&&void 0===a[n])return n}while(++n<o)}else do{if(a[n]===e)return n}while(++n<o);return-1});var e=function(t,n){if(!t)return t;if("string"!=typeof t&&t instanceof Element)return o(t);var a;function o(t){if(t.isEle)return t;t.isEle=!0;var n={prototype:Element,val:function(e){return"string"==typeof e?this.value=e:this.value},html:function(e){return"string"==typeof e?this.innerHTML=e:this.innerHTML},next:function(){for(var t=this.nextSibling;t instanceof Text;)t=t.nextSibling;return e(t)},addClass:function(e){return classArray=this.className.split(" "),-1==classArray.indexOf(e)&&(this.className+=" "+e),this},removeClass:function(e){if(classArray=this.className.split(" "),-1!=classArray.indexOf(e))return classArray.splice(classArray.indexOf(e),1),this.className=classArray.join(" "),this},hasClass:function(e){return classArray=this.className.split(" "),classArray.indexOf(e)>-1},ele:function(t){return e(t,this)},getInput:function(e){return this.ele("input[name="+e+"]")[0]},addEvent:function(e,t){return this.addEventListener?this.addEventListener(e,t):this.attachEvent&&this.attachEvent("on"+e,function(e){(e=e||window.event).target=e.target||e.srcElement,t(e)}),this},target:function(e){if("string"==typeof e)if(document.dispatchEvent){var t=document.createEvent("HTMLEvents");t.initEvent(e,!0,!0),this.dispatchEvent(t)}else document.attachEvent&&this.fireEvent("on"+e);return this}};if(t.__proto__)n.__proto__=t.__proto__,t.__proto__=n;else for(var a in n)t[a]=n[a];return t}if(n=n||document,(a=2==t.split("#").length?document.getElementById(t.split("#")[1]):n.querySelectorAll(t))instanceof Element)a=o(a);else if(a){for(var r=0;r<a.length;r++)o(a[r]);a.call=function(e,t,n){for(var o=0;o<a.length;o++)a[o][e](t,n)}}else console.error("unknow ele type ",t);return a},t=function(t){this.modalTimer=null,this.vaptchaObj=null,this.form=e(document.body),this.options=t||{}};t.prototype={constructor:t,isPhone:function(e){return!!/^[1][3,4,5,7,8][0-9]{9}$/.test(e)},showMsg:function(e,t){var n=t?".vaptcha-tip-success":".vaptcha-tip-warn";this.modalTimer&&clearTimeout(this.modalTimer),modal=this.form.ele(n)[0],modal.removeClass("none"),modal.ele(".dz-tip-text")[0].innerText=e,this.modalTimer=setTimeout(function(){modal.addClass("none")},1e3)},getFormData:function(e){for(var t=e.ele("input"),n={},a=0;a<t.length;a++)t[a].name&&(n[t[a].name]=t[a].value);return n},stopDefault:function(e){e&&e.preventDefault?(e.stopPropagation(),e.preventDefault()):(e.cancelBubble=!0,e.returnValue=!1)},ajax:function(e){var t,n=e.url,a=e.success,o=e.error,r=e.type||"GET",s=e.data||null;window.ActiveXObject?t=new ActiveXObject("Microsoft.XMLHTTP"):window.XMLHttpRequest&&(t=new XMLHttpRequest),t.open(r,this.options.site_url+n),"undefined"==typeof FormData&&t.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),t.send(function(e){if("object"!=typeof e)return e;if("function"==typeof FormData){var t=new FormData;for(var n in e)t.append(n,e[n]);return t}var a=new Array,o=0;for(var n in e)a[o]=encodeURIComponent(n)+"="+encodeURIComponent(e[n]),o++;return a.join("&")}(s)),t.onreadystatechange=function(e){if(4===t.readyState){var n=JSON.parse(t.responseText);200===t.status?a&&a(n):o&&o(n)}}},initVaptcha:function(e){var t=this,n=e.form,a=e.success,o=new function(){this.isPass=!1,this.vaptcha=null,this.refresh=function(){this.isPass&&(this.vaptcha.destroy(),t.initVaptcha(e))}},r=function(){t.ajax({url:"/plugin.php?id=phone_auth&action=getChallenge&t="+(new Date).getTime(),success:function(r){var s={vid:r.vid,challenge:r.challenge,container:e.element,type:e.type||"float",style:t.options.vaptcha_style||"dark",https:e.https||!1,color:t.options.vaptcha_color||"#3c8aff",lang:"zh-CN",outage:"/plugin.php?id=phone_auth&action=downtime",success:function(e,t){if(n){var r=n.getElementsByTagName("input");r.vaptcha_challenge.value=t,r.vaptcha_token.value=e}o.isPass=!0,a&&a(e,t)}};window.vaptcha(s,function(e){if(n){var t=n.getElementsByTagName("input");t.vaptcha_challenge.value="",t.vaptcha_token.value=""}o.vaptcha=e,o.vaptcha.init()})}})},s=document.getElementById("vaptcha_v_js");return s?r():(s=document.createElement("script"),protocol=e.https?"https":"http",s.src=protocol+"://cdn.vaptcha.com/v.js",s.id="vaptcha_v_js",s.onload=s.onreadystatechange=function(){this.readyState&&"loaded"!=this.readyState&&"complete"!=this.readyState||(r(),s.onload=s.onreadystatechange=null)},document.getElementsByTagName("head")[0].appendChild(s)),o},buttonCountDown:function(e,t){var n=this;t=t||120,e.setAttribute("disabled","disabled"),this.countDownTimer&&clearTimeout(this.countDownTimer),function a(){if(0==t)return e.removeAttribute("disabled"),void(e.innerText=n.options.lang.send_code);e.innerText=t+"s",t--,n.countDownTimer=setTimeout(a,1e3)}()},passwordLevel:function(e,t){e.addEvent("keyup",function(n){n=n||window.event;var a=new RegExp("^(?=.{8,})(?=.*[A-Z])(?=.*[a-z])(?=.*[0-9])(?=.*\\W).*$","g"),o=new RegExp("^(?=.{7,})(((?=.*[A-Z])(?=.*[a-z]))|((?=.*[A-Z])(?=.*[0-9]))|((?=.*[a-z])(?=.*[0-9]))).*$","g"),r=(new RegExp("(?=.{6,}).*","g"),new RegExp("[a-zA-Z]"));e.value.length>=6?a.test(e.value)?(t.removeClass("pw-medium"),t.removeClass("pw-weak"),t.addClass("pw-strong"),canBeSubmit=!0):o.test(e.value)||r.test(e.value)?(t.removeClass("pw-strong"),t.removeClass("pw-weak"),t.addClass("pw-medium"),canBeSubmit=!0):(t.removeClass("pw-strong"),t.removeClass("pw-medium"),t.addClass("pw-weak"),canBeSubmit=!1):e.value.length>0&&e.value.length<6?(t.removeClass("pw-strong"),t.removeClass("pw-medium"),t.addClass("pw-weak"),canBeSubmit=!1):(t.removeClass("pw-strong"),t.removeClass("pw-medium"),t.removeClass("pw-weak"),canBeSubmit=!1),13==n.keyCode&&signUp()})},login_run:function(t){var n=this,a=e("form[name=login]")[0],o=e("#loginphone_"+t.id);this.form=o;var r,s,l=a.id.split("_")[1],i=e("#returnmessage_"+l),u=!1,d=!1,p=!1;function c(){var a=o.ele(".v-login-form")[0],s=a.ele(".vaptcha_container"),l=a.ele("input");if(i.html(t.lang.login_member),u)l.call("val","");else{u=!0;var d=function(){var e=n.getFormData(a);e.user.length>0&&a.getInput("user").removeClass("error"),e.password.length>5&&a.getInput("password").removeClass("error"),e.user.length>0&&e.password.length>5&&e.vaptcha_token?a.ele(".login-button")[0].removeAttribute("disabled"):a.ele(".login-button")[0].setAttribute("disabled","disabled")};r=n.initVaptcha({element:s,form:a,success:d}),l.call("addEvent","keyup",d),l.call("addEvent","blur",d),e(".login-button")[0].addEvent("click",function(e){n.ajax({url:"/plugin.php?id=phone_auth&mod=logging&action=login&loginsubmit=yes",type:"POST",data:n.getFormData(a),success:function(e){window.location.reload()},error:function(e){if(["user","password"].indexOf(e.error_pos)>=0&&(a.getInput(e.error_pos).addClass("error"),e.msg&&n.showMsg(e.msg)),"bind_phone"==e.error_pos)return o.ele(".bind-phone-form")[0].ele(".user-name")[0].html(e.msg),void g();r.refresh(),a.ele(".login-button")[0].setAttribute("disabled","disabled")}})})}}function h(){var a=o.ele(".lost-password-form")[0],r=a.ele(".vaptcha_container"),l=a.ele("input"),u=a.ele(".dz-btn-code")[0];if(i.html(t.lang.password_reset),d)return l.call("val",""),this.countDownTimer&&clearTimeout(this.countDownTimer),a.getInput("phone").removeAttribute("disabled"),a.ele("button").call("setAttribute","disabled","disabled"),u.removeAttribute("disabled"),u.html(t.lang.send_code),a.ele(".pw-strength")[0].className="pw-strength",void s.refresh();d=!0,s=n.initVaptcha({element:r,form:a,success:function(){h(),u.click(),a.ele(".send-code-group")[0].removeClass("none")}});var h=function(){n.isPhone(a.getInput("phone").value)&&a.getInput("phone").removeClass("error"),/^\d{6}$/.test(a.getInput("code").value)&&a.getInput("code").removeClass("error"),n.isPhone(a.getInput("phone").value)&&/^\d{6}$/.test(a.getInput("code").value)?a.ele(".next-step")[0].removeAttribute("disabled"):a.ele(".next-step")[0].setAttribute("disabled","disabled")};l.call("addEvent","keyup",h),a.ele(".next-step")[0].addEvent("click",function(){n.ajax({url:"/plugin.php?id=phone_auth&action=verifyCode",type:"POST",data:{phone:a.getInput("phone").value,code:a.getInput("code").value},success:function(r){a.addClass("none"),e(".reset-password")[0].removeClass("none"),function(){var e=o.ele(".reset-password")[0],a=e.ele("input");e.getInput("new_password");i.html(t.lang.password_reset),p&&(a.call("val",""),e.ele("button").call("setAttribute","disabled","disabled"));p=!0,n.passwordLevel(e.getInput("new_password"),e.ele(".pw-strength")[0]),a.call("addEvent","keyup",function(){e.getInput("new_password").value.length==e.getInput("verify_password").value.length&&e.getInput("new_password").value.length>5&&e.getInput("new_password").value.length<21?e.ele(".submit-btn")[0].removeAttribute("disabled"):e.ele(".submit-btn")[0].setAttribute("disabled","disabled")}),e.ele(".submit-btn")[0].addEvent("click",function(){n.ajax({url:"/plugin.php?id=phone_auth&action=resetPassword",type:"POST",data:{new_password:e.getInput("new_password").value},success:function(e){n.showMsg(e.msg,!0),setTimeout(function(){o.ele(".vaptcha-dz-popup").call("addClass","none"),o.ele(".v-login-form")[0].removeClass("none"),c()},1e3)},error:function(e){n.showMsg(e.msg)}})})}()},error:function(e){a.ele(".next-step")[0].setAttribute("disabled","disabled"),"phone"==e.error_pos&&a.getInput("phone").addClass("error"),"code"==e.error_pos&&a.getInput("code").addClass("error"),n.showMsg(e.msg)}})}),u.addEvent("click",function(){h(),n.ajax({url:"/plugin.php?id=phone_auth&action=sendcode",type:"POST",data:{phone:a.getInput("phone").value,vaptcha_token:a.getInput("vaptcha_token").value,vaptcha_challenge:a.getInput("vaptcha_challenge").value},success:function(e){n.showMsg(e.msg,!0),!0,u.setAttribute("disabled","disabled"),a.getInput("phone").setAttribute("disabled","disabled"),n.buttonCountDown(u,120)},error:function(e){"vaptcha"===e.error_pos&&s.refresh(),"phone"===e.error_pos&&a.getInput("phone").addClass("error"),301===e.status?n.buttonCountDown(u,e.msg):n.showMsg(e.msg)}})})}function g(){var e=o.ele(".bind-phone-form")[0];o.ele(".vaptcha-dz-popup").call("addClass","none"),e.removeClass("none");var a=e.ele(".dz-btn-code")[0];i.html(t.lang.bind_phone);var r=function(){n.isPhone(e.getInput("phone").value)?(e.getInput("phone").removeClass("error"),s.isPass&&6===e.getInput("code").value.length&&e.ele(".bind-phone-btn")[0].removeAttribute("disabled")):e.getInput("phone").addClass("error")},s=n.initVaptcha({element:e.ele(".vaptcha_container")[0],form:e,success:function(){a.target("click"),e.ele(".send-code-group")[0].removeClass("none")}});e.ele("input").call("addEvent","blur",r),e.ele("input").call("addEvent","focus",function(e){e.target.removeClass("error")}),e.getInput("code").addEvent("keyup",function(e){r(),6!==this.value.length?e.target.addClass("error"):e.target.removeClass("error")}),a.addEvent("click",function(){n.ajax({url:"/plugin.php?id=phone_auth&action=bindPhoneCode",type:"POST",data:n.getFormData(e),success:function(t){n.showMsg(t.msg,!0),a.setAttribute("disabled","disabled"),e.getInput("phone").setAttribute("disabled","disabled"),n.buttonCountDown(a,120)},error:function(t){"vaptcha"===t.error_pos&&s.refresh(),"phone"===t.error_pos&&e.getInput("phone").addClass("error"),301===t.status?n.buttonCountDown(a,t.msg):n.showMsg(t.msg)}})}),e.ele(".bind-phone-btn")[0].addEvent("click",function(t){n.ajax({url:"/plugin.php?id=phone_auth&action=bindPhone",type:"POST",data:n.getFormData(e),success:function(e){200===e.status&&window.location.reload()},error:function(t){"phone"===t.error_pos&&e.getInput("phone").addClass("error"),s.refresh(),e.ele(".bind-phone-btn")[0].setAttribute("disabled","disabled"),n.showMsg(t.msg)}})})}var v=function(){o.ele(".vaptcha-dz-popup").call("addClass","none"),o.ele(".lost-password-form")[0].removeClass("none"),h()};e(".lost-password")[0].addEvent("click",v),t.islostpwd?v():t.bind_phone?g():c()},register_run:function(t){var n=this,a=e("#registerform"),o=e("#registerphone_"+t.id);this.form=o;var r={username:!1,email:0==t.has_email,password:!1,phone:!1,vaptcha:!1,code:!1,qq:0==t.has_email,agreebbrule:0==t.has_bbrules};a.html("");var s=e(".dz-btn-code")[0];function l(){console.log(r);var t=r.username&&r.email&&r.password&&r.phone;return t&&r.code&&r.agreebbrule?e("#register_btn").removeAttribute("disabled"):e("#register_btn").setAttribute("disabled","disabled"),t}if(o.ele("input").call("addEvent","focus",function(e){var t=e.target;t.removeClass("error"),t.next().removeClass("error")}),o.getInput(t.username).addEvent("focus",function(e){e.target.next().html(t.lang.username)}),o.getInput(t.username).addEvent("keyup",function(e){var t=e.target;t.value=trim(t.value),r.username=!(t.value.length<3||t.value.length>15)}),o.getInput(t.username).addEvent("blur",function(e){var t=e.target;r.username||(r.username=!1,t.addClass("error"),t.next().addClass("error"))}),1==t.has_email&&(o.getInput(t.email).addEvent("focus",function(e){e.target.next().html(t.lang.email)}),o.getInput(t.email).addEvent("keyup",function(e){var t=e.target;t.value=trim(t.value),r.email=/^(\w)+(\.\w+)*@(\w)+((\.\w{2,3}){1,3})$/.test(t.value)}),o.getInput(t.email).addEvent("blur",function(e){var n=e.target;r.email||(n.addClass("error"),n.next().addClass("error"),n.next().html(t.lang.email_error))})),t.has_qq&&(o.getInput("qq").addEvent("focus",function(e){e.target.next().html("")}),o.getInput("qq").addEvent("keyup",function(e){var t=e.target;t.value=trim(t.value),t.value&&(r.qq=!0)}),o.getInput("qq").addEvent("blur",function(e){var n=e.target;n.target("keyup"),r.qq||(n.addClass("error"),n.next().addClass("error"),n.next().html(t.lang.qq_error))})),n.passwordLevel(o.getInput(t.password),o.ele(".pw-strength")[0]),o.getInput(t.password).addEvent("blur",function(e){var t=e.target;t.value.length<6||t.value.length>20?(r.password=!1,t.addClass("error"),t.next().addClass("error")):r.password=!0}),o.getInput("phone").addEvent("focus",function(e){e.target.next().html("")}),o.getInput("phone").addEvent("keyup",function(e){var t=e.target;t.value=parseInt(t.value)?parseInt(t.value):"",r.phone=n.isPhone(t.value)}),o.getInput("phone").addEvent("blur",function(e){var n=e.target;n.target("keyup"),r.phone||(n.addClass("error"),n.next().addClass("error"),n.next().html(t.lang.phone))}),o.getInput("code").addEvent("keyup",function(e){var t=e.target;t.value=trim(t.value),r.code=/^\d{6}$/.test(t.value)}),o.getInput("code").addEvent("blur",function(e){var t=e.target;t.target("keyup"),!r.code&&t.addClass("error")}),1===t.has_bbrules){o.ele(".protocal-link")[0].addEvent("click",function(){showDialog($("layer_bbrule").innerHTML,"info",""),$("fwin_dialog_close").style.display="none"});var i=function(){r.agreebbrule=e("#agreebbrule").checked,l()};e("#agreebbrule").addEvent("click",i),e("#agreebbrule").next().addEvent("click",i)}o.ele("input").call("addEvent","keyup",l),s.addEvent("click",function(){if(o.getInput("phone").target("blur"),!r.phone)return!1;n.ajax({url:"/plugin.php?id=phone_auth&action=sendRegisterCode",type:"POST",data:{phone:o.getInput("phone").value,vaptcha_token:o.getInput("vaptcha_token").value,vaptcha_challenge:o.getInput("vaptcha_challenge").value},success:function(e){s.setAttribute("disabled","disabled"),o.getInput("phone").setAttribute("disabled","disabled"),n.buttonCountDown(s,120)},error:function(e){"vaptcha"===e.error_pos?(o.ele(".vaptcha_container")[0].next().html(e.msg),n.initVaptcha({element:o.ele(".vaptcha_container"),form:o,success:function(){l(),o.ele(".vaptcha_container")[0].next().html(""),s.target("click")}})):["phone","code"].indexOf(e.error_pos)>=0?(o.getInput(e.error_pos).addClass("error"),o.getInput(e.error_pos).next().addClass("error"),o.getInput(e.error_pos).next().html(e.msg)):301===e.status?n.buttonCountDown(s,e.msg):n.showMsg(e.msg)}})}),e("#register_btn").addEvent("click",function(){n.ajax({url:"/plugin.php?id=phone_auth&action=register",data:n.getFormData(o),type:"POST",success:function(e){200===e.status&&window.location.reload()},error:function(e){var a=o.getInput(t.username),r=o.getInput(t.email);"username"===e.error_pos?(a.addClass("error"),a.next().addClass("error"),a.next().html(e.msg)):"email"===e.error_pos?(r.addClass("error"),r.next().addClass("error"),r.next().html(e.msg)):n.showMsg(e.msg)}})}),n.initVaptcha({element:o.ele(".vaptcha_container"),form:o,success:function(){r.vaptcha=!0,o.ele(".dz-code-group")[0].removeClass("none"),o.ele(".vaptcha_container")[0].next().html(""),s.target("click"),l()}})},popup_captcha:function(t,n){var a=this;(n=n||e("#popup_vaptcha")).ele(".vp-header")[0].style.marginTop=((window.innerHeight||document.documentElement.clientHeight)-230)/2+"px",n.style.display="block",n.ele(".vp-mask")[0].addEvent("click",function(e){n.style.display="none"}),(void 0===n.is_pass||n.is_pass)&&(n.ele(".vp-content")[0].html('<div class="loading"><span style="animation-delay: -.32s"></span><span style="animation-delay: -.16s"></span><span></span></div>'),a.initVaptcha({element:n.ele(".vp-content"),type:"embed",form:t,success:function(){n.is_pass=!0,a.ajax({url:"/plugin.php?id=phone_auth&mod=logging&action=login&loginsubmit=yes",type:"POST",data:a.getFormData(t),success:function(e){window.location.reload()},error:function(e){if(n.style.display="none","bind_phone"==e.error_pos)return showWindow("login","member.php?mod=logging&action=login");e.msg&&errorhandle_ls(e.msg,{loginperm:"4"})}})}}),n.is_pass=!1)},login_simple_run:function(t){var n=this,a=e("#lsform").ele(".fastlg")[0],o=a.ele(".pns")[0],r=a.ele(".v-login-simple")[0];a.replaceChild(r,o),r.ele(".login-btn")[0].addEvent("click",function(e){n.stopDefault(e);var t=r.getInput("user"),a=r.getInput("password");t.val()&&a.val()?n.popup_captcha(r):showWindow("login","member.php?mod=logging&action=login")})}},window.v_helper=t,window.ele=e}();